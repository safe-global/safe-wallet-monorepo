#!/bin/bash
set -euo pipefail

# Get all staged files once
all_staged=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if there are unstaged changes to preserve
has_unstaged_changes=false
if ! git diff --quiet; then
  has_unstaged_changes=true
fi

# Stash unstaged changes (keep staged changes in working tree)
if [ "$has_unstaged_changes" = true ]; then
  git stash push --keep-index --quiet -m "pre-commit: unstaged changes"
fi

# Cleanup function to restore unstaged changes
cleanup() {
  if [ "$has_unstaged_changes" = true ]; then
    git stash pop --quiet 2>/dev/null || true
  fi
}

# Restore unstaged changes on exit (success or failure)
trap cleanup EXIT

# Run prettier on staged files
staged_prettier_files=$(echo "$all_staged" | grep -E '\.(js|jsx|ts|tsx|mjs|cjs|md|yml|json|css)$' || true)

if [ -n "$staged_prettier_files" ]; then
  echo "Running prettier on staged files..."
  echo "$staged_prettier_files" | xargs yarn exec prettier --write
  echo "$staged_prettier_files" | xargs git add
fi

# Run eslint --fix on staged web files
staged_web_lint_files=$(echo "$all_staged" | grep -E '^apps/web/src/.*\.(js|jsx|ts|tsx)$' || true)

if [ -n "$staged_web_lint_files" ]; then
  echo "Running eslint --fix on staged web files..."
  # Convert to relative paths and run from apps/web directory
  web_relative_files=$(echo "$staged_web_lint_files" | sed 's|^apps/web/||')
  (cd apps/web && echo "$web_relative_files" | xargs yarn exec eslint --fix)
  echo "$staged_web_lint_files" | xargs git add
fi

# Run eslint --fix on staged mobile files
staged_mobile_lint_files=$(echo "$all_staged" | grep -E '^apps/mobile/src/.*\.(js|jsx|ts|tsx)$' || true)

if [ -n "$staged_mobile_lint_files" ]; then
  echo "Running eslint --fix on staged mobile files..."
  # Convert to relative paths and run from apps/mobile directory
  mobile_relative_files=$(echo "$staged_mobile_lint_files" | sed 's|^apps/mobile/||')
  (cd apps/mobile && echo "$mobile_relative_files" | xargs yarn exec eslint --fix)
  echo "$staged_mobile_lint_files" | xargs git add
fi

# Generate mobile icon types if selection.json changed
if echo "$all_staged" | grep -q "apps/mobile/assets/fonts/safe-icons/selection.json"; then
  echo "Generating mobile icon types..."
  node ./apps/mobile/scripts/generateIconTypes.js
  git add ./apps/mobile/src/types/iconTypes.ts
fi

# Run type-check on staged TypeScript files in apps/web
staged_web_ts_files=$(echo "$all_staged" | grep -E '^apps/web/.*\.(ts|tsx)$' || true)

if [ -n "$staged_web_ts_files" ]; then
  echo "Running type-check for web app..."
  yarn workspace @safe-global/web type-check
fi
