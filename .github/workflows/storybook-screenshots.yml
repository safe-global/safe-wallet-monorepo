name: Storybook Screenshots

on:
  # TODO: Revert to workflow_run trigger after testing
  pull_request:
    paths:
      - 'apps/web/src/**/*.stories.@(ts|tsx|js|jsx)'
      - '.github/workflows/storybook-screenshots.yml'
      - '.github/scripts/generate-story-urls.sh'
  # workflow_run:
  #   workflows: ["Web Deploy to dev/staging"]
  #   types:
  #     - completed

permissions:
  pull-requests: write
  contents: write

jobs:
  screenshot:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get changed story files
        id: changed-stories
        run: |
          # Get the base branch (usually dev or main)
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Find changed story files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '\.(stories|story)\.(tsx?|jsx?)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No story files changed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed story files:"
            echo "$CHANGED_FILES"
            # Store as multiline output
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Extract branch name and generate story URLs
        if: steps.changed-stories.outputs.has_changes == 'true'
        id: story-urls
        env:
          # Use env var to prevent code injection via branch name
          # When reverting to workflow_run trigger, use: github.event.workflow_run.head_branch
          BRANCH_NAME: ${{ github.head_ref }}
          CHANGED_FILES: ${{ steps.changed-stories.outputs.files }}
        run: |
          # Normalize branch name for URL
          NORMALIZED=$(echo "$BRANCH_NAME" | sed 's/[^a-z0-9]/_/ig' | sed 's/[A-Z]/\L&/g')
          echo "normalized_branch=$NORMALIZED" >> $GITHUB_OUTPUT
          echo "Normalized branch: $NORMALIZED"

          BASE_URL="https://${NORMALIZED}--walletweb.review.5afe.dev/storybook"

          # Generate URLs from changed story files
          URLS=""
          while IFS= read -r file; do
            if [ -z "$file" ]; then continue; fi

            # Remove apps/web/ prefix if present
            normalized="${file#apps/web/}"
            # Remove src/ prefix
            normalized="${normalized#src/}"
            # Remove file extension and .stories suffix
            normalized="${normalized%.*}"
            normalized="${normalized%.stories}"
            normalized="${normalized%.story}"
            # Remove /index if present
            normalized="${normalized%/index}"
            # Convert path separators to hyphens and lowercase
            story_id=$(echo "$normalized" | tr '/' '-' | tr '[:upper:]' '[:lower:]')

            # For now, add a default story variant (most stories have at least "default" or the component name)
            # The action will try to capture this URL
            url="${BASE_URL}/iframe.html?id=${story_id}--default&viewMode=story"

            if [ -z "$URLS" ]; then
              URLS="$url"
            else
              URLS="$URLS,$url"
            fi
          done <<< "$CHANGED_FILES"

          echo "urls=$URLS" >> $GITHUB_OUTPUT
          echo "Generated URLs:"
          echo "$URLS" | tr ',' '\n'

      - name: Capture and comment screenshots
        if: steps.changed-stories.outputs.has_changes == 'true'
        uses: saadmk11/comment-webpage-screenshot@v1
        with:
          capture_urls: ${{ steps.story-urls.outputs.urls }}
          upload_to: github_branch
          github_token: ${{ secrets.GITHUB_TOKEN }}
          comment_template: |
            ## ðŸ“¸ Storybook Component Screenshots

            Found changed components in this PR.

            **Storybook Preview:** https://${{ steps.story-urls.outputs.normalized_branch }}--walletweb.review.5afe.dev/storybook/

            {screenshots}

            ---
            *Screenshots are automatically captured from changed story files.*
