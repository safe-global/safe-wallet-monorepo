name: ðŸ”„ Back-merge Main to Dev

on:
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create PR instead of direct push'
        required: false
        type: boolean
        default: false

  # Optionally auto-trigger after production releases
  # Uncomment if you want automatic back-merge after publishing a release
  # release:
  #   types: [published]

jobs:
  backmerge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch latest changes
        run: |
          git fetch origin main
          git fetch origin dev

      - name: Check if back-merge is needed
        id: check
        run: |
          # Check if main has commits not in dev
          COMMITS_AHEAD=$(git rev-list --count origin/dev..origin/main)

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "â„¹ï¸  Dev is already up to date with main"
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“Š Main is $COMMITS_AHEAD commit(s) ahead of dev"
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Attempt merge (check for conflicts)
        if: steps.check.outputs.needed == 'true'
        id: merge_check
        run: |
          git checkout -b temp-backmerge origin/dev

          if git merge --no-commit --no-ff origin/main; then
            echo "âœ… Clean merge - no conflicts"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            git merge --abort
          else
            echo "âš ï¸  Merge conflicts detected"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            git merge --abort
          fi

      - name: Direct merge (no conflicts, no PR requested)
        if: steps.check.outputs.needed == 'true' && steps.merge_check.outputs.has_conflicts == 'false' && inputs.create_pr == false
        run: |
          git checkout dev
          git reset --hard origin/dev
          git merge origin/main -m "Back-merge main to dev

          Automated back-merge after release.

          ðŸ¤– Generated by [Back-merge workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          git push origin dev
          echo "âœ… Merged main to dev directly"

      - name: Create PR for back-merge (conflicts or PR requested)
        if: steps.check.outputs.needed == 'true' && (steps.merge_check.outputs.has_conflicts == 'true' || inputs.create_pr == true)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a branch for the back-merge
          BRANCH_NAME="backmerge/main-to-dev-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME" origin/dev

          # Attempt merge
          if git merge origin/main -m "Back-merge main to dev"; then
            git push origin "$BRANCH_NAME"

            # Create PR
            CONFLICT_STATUS="${{ steps.merge_check.outputs.has_conflicts }}"
            if [ "$CONFLICT_STATUS" = "true" ]; then
              BODY="## Back-merge from main

          This PR syncs changes from \`main\` back to \`dev\` after a release.

          âš ï¸ **This merge has conflicts that need manual resolution.**

          ðŸ¤– *Created automatically by [Back-merge workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
            else
              BODY="## Back-merge from main

          This PR syncs changes from \`main\` back to \`dev\` after a release.

          âœ… Clean merge - no conflicts detected.

          ðŸ¤– *Created automatically by [Back-merge workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
            fi

            gh pr create \
              --base dev \
              --head "$BRANCH_NAME" \
              --title "ðŸ”„ Back-merge main to dev" \
              --body "$BODY"

            echo "âœ… Back-merge PR created"
          else
            # Push with conflicts
            git add -A
            git commit -m "Back-merge main to dev (with conflicts)"
            git push origin "$BRANCH_NAME"

            gh pr create \
              --base dev \
              --head "$BRANCH_NAME" \
              --title "ðŸ”„ Back-merge main to dev (CONFLICTS)" \
              --body "## âš ï¸  Back-merge from main - CONFLICTS DETECTED

          This PR syncs changes from \`main\` back to \`dev\` after a release.

          **Action Required:** Please resolve merge conflicts manually.

          ðŸ¤– *Created automatically by [Back-merge workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

            echo "âš ï¸  Back-merge PR created with conflicts"
          fi

      - name: Notify on Slack
        if: steps.check.outputs.needed == 'true' && vars.SLACK_WEBHOOK_URL
        continue-on-error: true
        run: |
          if [ "${{ steps.merge_check.outputs.has_conflicts }}" = "true" ]; then
            MESSAGE="âš ï¸ *Back-merge Created (Conflicts Detected)*\n\nA PR has been created to back-merge \`main\` to \`dev\`. Manual conflict resolution is required."
            EMOJI="âš ï¸"
          elif [ "${{ inputs.create_pr }}" = "true" ]; then
            MESSAGE="ðŸ”„ *Back-merge PR Created*\n\nA PR has been created to back-merge \`main\` to \`dev\`."
            EMOJI="ðŸ”„"
          else
            MESSAGE="âœ… *Back-merge Completed*\n\nChanges from \`main\` have been merged to \`dev\` automatically."
            EMOJI="âœ…"
          fi

          curl -X POST "${{ vars.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"$EMOJI Back-merge Status\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$MESSAGE\"
                  }
                }
              ]
            }"

      - name: Summary
        if: steps.check.outputs.needed == 'true'
        run: |
          echo "### ðŸ”„ Back-merge Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.merge_check.outputs.has_conflicts }}" = "true" ]; then
            echo "**Status:** âš ï¸  Conflicts detected" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** PR created - manual resolution required" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.create_pr }}" = "true" ]; then
            echo "**Status:** âœ… PR created for review" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… Merged directly to dev" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** None - back-merge complete" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary (no merge needed)
        if: steps.check.outputs.needed == 'false'
        run: |
          echo "### â„¹ï¸  No Back-merge Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dev is already up to date with main." >> $GITHUB_STEP_SUMMARY
