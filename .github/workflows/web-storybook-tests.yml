name: Web Storybook Snapshot Tests

permissions:
  contents: read

on:
  pull_request:
    paths:
      - apps/web/**
      - .github/workflows/web-storybook-tests.yml

  push:
    branches:
      - main
    paths:
      - apps/web/**
      - .github/workflows/web-storybook-tests.yml

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  storybook-snapshots:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: ./.github/actions/yarn

      - name: Run Storybook snapshot tests
        run: yarn test:storybook:ci
        working-directory: apps/web
        env:
          NEXT_PUBLIC_IS_OFFICIAL_HOST: true

      - name: Upload snapshot diffs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: storybook-snapshot-diffs
          path: apps/web/src/__tests__/__snapshots__/
          retention-days: 7
