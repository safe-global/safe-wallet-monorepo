import {useEffect} from "react";
import Head from "next/head";
import type {NextPage} from "next";
import type {SafeInfo} from "@gnosis.pm/safe-react-gateway-sdk";

import {useAppDispatch, useAppSelector} from "store";
import {selectSafeInfo, setSafeInfo} from "store/safeInfoSlice";
import {initSafeInfoService} from "services/safeInfoService";
import SafeHeader from "components/common/SafeHeader";
import useSafeAddress from "services/useSafeAddress";

const Home: NextPage = () => {
  const { address, chainId } = useSafeAddress()
  const dispatch = useAppDispatch()

  const safeInfo = useAppSelector(selectSafeInfo);

  useEffect(() => {
    if (!address || !chainId) return

    const {onSuccess, onError, unsubscribe} = initSafeInfoService(chainId, address)

    const handleSuccess = (data: SafeInfo) => {
      dispatch(setSafeInfo(data))
    }
    const handleError = (error: Error) => {
      console.error("Error loading Safe info", error)
    }

    onSuccess(handleSuccess)
    onError(handleError)

    return () => {
      unsubscribe()
    }
  }, [dispatch, address, chainId])

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <SafeHeader />

      <main>Hello Balances of {address}</main>
      <pre>{JSON.stringify(safeInfo, null, 2)}</pre>
    </div>
  );
};

export default Home;
