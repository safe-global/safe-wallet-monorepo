appId: global.safe.mobileapp.ios
---
# ===========================================
# Transaction Checks (Reusable Component)
# ===========================================
# Tests the transaction checks screen for pending transactions
# This replaces the created/executed dates in pending transaction views
#
# Environment variables:
#   BALANCE_CHANGE_PATTERN: Optional text/pattern to verify in Balance change section
#                          Example: ".*-.*0\.00002.*" or "ETH" or ".*NATIVE.*"
#   TRANSACTION_SIMULATION_PATTERN: Optional text/pattern to verify in Transaction simulation section
#                                  Example: "Success" or ".*Loading.*"
#   VERIFY_TENDERLY_LINK: Set to "true" to test clicking the Tenderly link and navigating back
#                        Defaults to false (test only runs if link is visible)

- evalScript: ${output.breadcrumbExists = false}

- assertVisible: 'Transaction checks'

- tapOn:
    text: 'Transaction checks'

# Verify Balance change section is visible
- assertVisible: '.*Balance change.*'

# Verify balance change pattern if provided
- assertVisible:
    text: '${BALANCE_CHANGE_PATTERN}'
    optional: true

# Verify Transaction simulation section is visible
- assertVisible: '.*Transaction simulation.*'

# Verify transaction simulation pattern if provided
- assertVisible:
    text: '${TRANSACTION_SIMULATION_PATTERN}'
    optional: true

# ===========================================
# Test Info Sheets
# ===========================================
# Test Balance change info sheet
# Tap directly on "Balance change" text to open the info sheet
- tapOn:
    text: '.*Balance change.*'

# Verify the Balance change info sheet opens
- assertVisible: 'Balance change'

# Verify the info description is visible
- assertVisible:
    text: '.*The balance change gives an overview of the implications of a transaction.*'

# Dismiss the sheet by swiping down
- swipe:
    direction: 'DOWN'
    startPoint: '50%,50%'
    endPoint: '50%,80%'

# Verify we're back on Transaction checks screen
- assertVisible: 'Transaction checks'

# Test Transaction simulation info sheet (only if simulation is enabled)
# Tap directly on "Transaction simulation" text to open the info sheet
- tapOn:
    text: '.*Transaction simulation.*'

# Verify the Simulation info sheet opens (only if simulation is enabled)
- assertVisible:
    text: 'Simulation'

# Verify the info description is visible (only if simulation is enabled)
- assertVisible:
    text: '.*The transaction can be simulated before execution to ensure that it will succeed.*'

# Dismiss the sheet by swiping down (only if sheet opened)
- swipe:
    direction: 'DOWN'
    startPoint: '50%,50%'
    endPoint: '50%,80%'
    optional: true

# Verify we're back on Transaction checks screen
- assertVisible: 'Transaction checks'

# Test Tenderly link if VERIFY_TENDERLY_LINK is set to "true" AND button is visible
# Check VERIFY_TENDERLY_LINK and set a pattern that will only match if we should test
- evalScript: '${output.tenderlyButtonPattern = (typeof VERIFY_TENDERLY_LINK !== "undefined" && VERIFY_TENDERLY_LINK === "true") ? "View details on Tenderly" : "NEVER_MATCH_TENDERLY_TEST_DISABLED_12345"}'

# Only test Tenderly link if VERIFY_TENDERLY_LINK is "true" and button is visible
# The pattern will never match if VERIFY_TENDERLY_LINK is not "true", so the when clause won't execute
- runFlow:
    when:
      visible:
        text: '${output.tenderlyButtonPattern}'
    commands:
      - assertVisible: 'View details on Tenderly'
      - tapOn: 'View details on Tenderly'
      # Wait for external link to open (Safari on iOS)
      - waitForAnimationToEnd:
          timeout: 3000
      # On iOS, external links open Safari. To return to the app:
      # Try multiple approaches to navigate back
      # 1. Look for breadcrumb (if link handler provides in-app return)
      - runFlow:
          when:
            visible:
              id: 'breadcrumb'
          commands:
            - tapOn:
                id: 'breadcrumb'
            - evalScript: '${output.breadcrumbExists = true}'
      # 2. Look for Done button in Safari (iOS standard)
      - runFlow:
          when:
            true: '${output.breadcrumbExists == false}'
            visible:
              text: 'Done'
          commands:
            - tapOn:
                text: 'Done'
      # 3. Wait for app to return to foreground
      - waitForAnimationToEnd:
          timeout: 2000
      # Verify we're back in the app (transaction checks screen should be visible)
      - assertVisible: 'Transaction checks'

# Go back from transaction checks screen
- tapOn:
    id: 'go-back'

# Verify we're back on the confirm transaction screen
- assertVisible: 'Confirm transaction'
