appId: ${APP_ID}
tags:
  - util
jsEngine: graaljs
---
- runScript:
    file: ../../../utils/scripts/defaults.js
# ===========================================
# Conflicting Transactions Card
# ===========================================
# Tests the conflicting transactions card display
# The card should show a warning banner and list of conflicting transactions
#
# Environment variables:
#   TX_TYPES: Comma-separated list of transaction types to verify (required)
#             Example: "Send,Settings change,Contract interaction"
#   TX_DETAILS: Comma-separated list of transaction details/amounts to verify (optional)
#               Example: "0.00002 ETH,addOwnerWithThreshold,someMethod"
#               Must match the number and order of TX_TYPES
#   CONFIRMATIONS_PATTERN: Regex pattern for confirmations to verify (optional)
#                          Defaults to '.*\d+/\d+.*' to match any confirmation format
#
# Note: This flow uses GraalJS for modern JavaScript features to parse comma-separated values

- assertVisible:
    text: '.*Conflicting transactions.*'

# Parse TX_TYPES into an array using GraalJS
- evalScript: "${output.txTypes = (typeof TX_TYPES !== 'undefined' && TX_TYPES) ? TX_TYPES.split(',').map(function(t) { return t.trim(); }) : []}"

# Parse TX_DETAILS into an array if provided
- evalScript: "${output.txDetails = (typeof TX_DETAILS !== 'undefined' && TX_DETAILS) ? TX_DETAILS.split(',').map(function(d) { return d.trim(); }) : []}"

# The empty string fallback (|| "") ensures assertions with missing array items don't fail
# Only provided transaction types/details will be validated

# Verify each transaction type is visible
# You can add up to 5 transactions
# Note: Since Maestro doesn't support JS expressions in optional, we make all optional: true
# The empty string fallback ensures assertions don't fail when items don't exist
- extendedWaitUntil:
    visible:
      text: '.*${output.txTypes[0] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txTypes[1] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txTypes[2] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txTypes[3] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txTypes[4] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txTypes[5] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

# Verify transaction details if provided (optional, matches corresponding TX_TYPES index)
- extendedWaitUntil:
    visible:
      text: '.*${output.txDetails[0] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txDetails[1] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txDetails[2] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txDetails[3] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txDetails[4] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

- extendedWaitUntil:
    visible:
      text: '.*${output.txDetails[5] || ""}.*'
      optional: true
    timeout: ${output.defaults.extendedWaitUntilTimeout}

# Verify confirmations are shown
# Use provided pattern or default to any confirmation format
- assertVisible:
    text: '${CONFIRMATIONS_PATTERN || ".*\\d+/\\d+.*"}'
